<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐播放器 - Spotify 风格</title>
    <link href="https://spotidown.app/img/favicon.ico" rel="icon"/>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            background-color: #121212;
            color: #fff;
        }

        #sidebar {
            width: 300px;
            background-color: #000;
            padding: 20px;
            overflow-y: auto;
            padding-bottom: 90px;
            /* 添加底部内边距 */
        }

        #main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            padding-bottom: 90px;
            /* 添加底部内边距 */
        }

        #player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #282828;
            padding: 20px;
            display: flex;
            align-items: center;
            height: 90px;
            /* 设置固定高度 */
            box-sizing: border-box;
            /* 确保padding不会增加元素的总高度 */
        }

        .album-item {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .album-item img {
            width: 80px;
            height: 80px;
            margin-right: 15px;
        }

        .album-item.active {
            background-color: #282828;
        }

        .song-item {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
        }

        .song-item:hover {
            background-color: #282828;
        }

        .song-item.active {
            background-color: #1DB954;
        }

        .song-number {
            width: 30px;
        }

        .song-title {
            flex-grow: 1;
        }

        .song-duration {
            width: 50px;
            text-align: right;
        }

        #progress-container {
            width: 100%;
            background-color: #404040;
            height: 5px;
            margin-top: 10px;
        }

        #progress {
            width: 0;
            height: 100%;
            background-color: #1DB954;
        }

        #album-info {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        #album-cover {
            width: 200px;
            height: 200px;
            margin-right: 20px;
        }

        #now-playing {
            display: flex;
            align-items: center;
            width: 30%;
        }

        #now-playing-cover {
            width: 60px;
            height: 60px;
            margin-right: 10px;
        }

        #controls {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40%;
        }

        #time-info {
            display: flex;
            justify-content: space-between;
            width: 30%;
        }

        button {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            margin: 0 10px;
        }

        #play-all {
            background-color: #1DB954;
            border: none;
            color: #fff;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 20px;
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <h2>专辑列表</h2>
        <ul id="album-list"></ul>
    </div>
    <div id="main-content">
        <div id="album-info">
            <img id="album-cover" src="" alt="专辑封面">
            <div>
                <h1 id="album-title"></h1>
                <h2 id="album-artist"></h2>
                <button id="play-all">播放全部</button>
            </div>
        </div>
        <div id="song-list"></div>
    </div>
    <div id="player">
        <div id="now-playing">
            <img id="now-playing-cover" src="" alt="正在播放">
            <div>
                <div id="now-playing-name"></div>
                <div id="now-playing-artist"></div>
            </div>
        </div>
        <div id="controls">
            <button id="previous">⏮</button>
            <button id="play-pause">▶</button>
            <button id="next">⏭</button>
        </div>
        <div id="time-info">
            <span id="current-time">0:00</span>
            <div id="progress-container">
                <div id="progress"></div>
            </div>
            <span id="duration">0:00</span>
        </div>
    </div>
    <script src="static/js/mp3.js"></script>
    <script>
        let currentAlbum = 0;
        let currentSong = 0;
        let isPlaying = false;
        let audio = new Audio();

        const albumList = document.getElementById('album-list');
        const songList = document.getElementById('song-list');
        const playPauseButton = document.getElementById('play-pause');
        const previousButton = document.getElementById('previous');
        const nextButton = document.getElementById('next');
        const progress = document.getElementById('progress');
        const nowPlayingCover = document.getElementById('now-playing-cover');
        const nowPlayingName = document.getElementById('now-playing-name');
        const nowPlayingArtist = document.getElementById('now-playing-artist');
        const playAllButton = document.getElementById('play-all');
        const albumCover = document.getElementById('album-cover');
        const albumTitle = document.getElementById('album-title');
        const albumArtist = document.getElementById('album-artist');
        const currentTimeDisplay = document.getElementById('current-time');
        const durationDisplay = document.getElementById('duration');

        function createAlbumList() {
            ALBUM.forEach((album, index) => {
                const li = document.createElement('li');
                li.className = 'album-item';
                li.innerHTML = `
                    <img src="${album.cover}" alt="${album.name}">
                    <span>${album.name}</span>
                `;
                li.onclick = () => showAlbum(index);
                albumList.appendChild(li);
            });
        }

        function showAlbum(index) {
            currentAlbum = index;
            songList.innerHTML = '';
            const album = ALBUM[index];
            albumCover.src = album.cover;
            albumTitle.textContent = album.name;
            albumArtist.textContent = album.artist;
            album.songs.forEach((song, i) => {
                const songItem = document.createElement('div');
                songItem.className = 'song-item';
                songItem.innerHTML = `
                    <div class="song-number">${i + 1}</div>
                    <div class="song-title">${song}</div>
                    <div class="song-duration" id="song-duration-${i}">loading...</div>
                `;
                songItem.onclick = () => playSong(i);
                songList.appendChild(songItem);
            });
            updateNowPlaying();
            updateAlbumListHighlight();
        }

        function updateAlbumListHighlight() {
            const albumItems = document.querySelectorAll('.album-item');
            albumItems.forEach((item, index) => {
                if (index === currentAlbum) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        function sanitizeFileName(name) {
            // 替换常见的问题字符
            return name.replace(/\//g, "_")
        }

        function playSong(index) {
            currentSong = index;
            const encodedAlbumName = sanitizeFileName(ALBUM[currentAlbum].name);
            const encodedSongName = sanitizeFileName(ALBUM[currentAlbum].songs[index]);
            audio.src = `static/song/${encodedAlbumName}/${encodedSongName}.mp3`;
            // 等音频元数据加载完后，再更新时长
            audio.onloadedmetadata = () => {
                document.getElementById(`song-duration-${index}`).textContent = formatTime(audio.duration);
                document.getElementById(`duration`).textContent = formatTime(audio.duration);
            };
            audio.play();
            isPlaying = true;
            updatePlayPauseButton();
            updateNowPlaying();
            updateSongListHighlight();
        }

        function updateSongListHighlight() {
            const songItems = document.querySelectorAll('.song-item');
            songItems.forEach((item, index) => {
                if (index === currentSong) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        function updatePlayPauseButton() {
            playPauseButton.textContent = isPlaying ? '❚❚' : '▶';
        }

        function updateNowPlaying() {
            nowPlayingCover.src = ALBUM[currentAlbum].cover;
            nowPlayingName.textContent = ALBUM[currentAlbum].songs[currentSong];
            nowPlayingArtist.textContent = ALBUM[currentAlbum].artist;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }

        function playNextSong() {
            currentSong++;
            if (currentSong >= ALBUM[currentAlbum].songs.length) {
                currentSong = 0;
                isPlaying = false;
                updatePlayPauseButton();
            } else {
                playSong(currentSong);
            }
        }

        playPauseButton.onclick = () => {
            if (isPlaying) {
                audio.pause();
            } else {
                audio.play();
            }
            isPlaying = !isPlaying;
            updatePlayPauseButton();
        };

        previousButton.onclick = () => {
            currentSong = (currentSong - 1 + ALBUM[currentAlbum].songs.length) % ALBUM[currentAlbum].songs.length;
            playSong(currentSong);
        };

        nextButton.onclick = () => {
            playNextSong();
        };

        playAllButton.onclick = () => {
            currentSong = 0;
            playSong(currentSong);
        };

        audio.ontimeupdate = () => {
            const percent = (audio.currentTime / audio.duration) * 100;
            progress.style.width = `${percent}%`;
            currentTimeDisplay.textContent = formatTime(audio.currentTime);
        };

        audio.onloadedmetadata = () => {
            durationDisplay.textContent = formatTime(audio.duration);
        };

        audio.onended = () => {
            playNextSong();
        };

        createAlbumList();
        showAlbum(0);
    </script>

</body>

</html>