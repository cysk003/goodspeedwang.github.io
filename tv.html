<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M3U8 在线播放器</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root { --bg:#0b0c0e; --fg:#e7e7ea; --muted:#9aa0a6; --accent:#4f46e5; }
    html { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    body { margin: 0; background: var(--bg); color: var(--fg); }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 24px; margin: 0 0 12px; }
    p { color: var(--muted); }
    .card { background: #111318; border: 1px solid #1f2430; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,.35); padding: 16px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input[type="url"] { flex: 1 1 560px; padding: 12px 14px; border-radius: 12px; border: 1px solid #2a3242; background: #0e1117; color: var(--fg); outline: none; }
    input[type="url"]::placeholder { color: #6b7280; }
    button { padding: 12px 16px; border-radius: 12px; border: 1px solid #2a3242; background: #151a24; color: var(--fg); cursor: pointer; font-weight: 600; }
    button.primary { background: var(--accent); border-color: #3e36c5; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    label { display: inline-flex; align-items: center; gap: 6px; color: #cbd5e1; }
    video { width: 100%; max-height: 65vh; background: #000; border-radius: 16px; margin-top: 12px; }
    .pill { display:inline-flex; gap:8px; align-items:center; background:#0f1420; border:1px solid #1f2430; padding:8px 12px; border-radius:999px; font-size:12px; color:#cbd5e1; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 8px; margin-top: 10px; }
    .stat { background:#0f1420; border:1px solid #1f2430; border-radius:12px; padding:10px 12px; }
    .stat h4 { margin:0 0 4px; font-size:12px; color:#94a3b8; font-weight:600; }
    .stat .v { font-variant-numeric: tabular-nums; font-size:14px; }
    .foot { margin-top:10px; font-size:12px; color:#94a3b8; }
    a { color:#a5b4fc; text-decoration: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>🎬 M3U8 在线播放器</h1>
    <div class="card">
      <div class="row" style="margin-bottom:10px">
        <input id="url" type="url" value="http://192.168.100.1:4022/rtp/239.3.1.129:8008" />
        <button id="load" class="primary">加载</button>
        <button id="play">播放/暂停</button>
        <label><input id="autoplay" type="checkbox" checked> 自动播放</label>
        <label><input id="muted" type="checkbox"> 静音</label>
      </div>
      <div class="row" style="margin-bottom:10px">
        <span class="pill">状态：<span id="status">空闲</span></span>
        <span class="pill">清晰度：<span id="level">-</span></span>
        <span class="pill">缓冲：<span id="buffer">-</span>s</span>
      </div>
      <video id="player" controls playsinline></video>
      <div class="grid">
        <div class="stat"><h4>分辨率</h4><div class="v" id="res">-</div></div>
        <div class="stat"><h4>帧率</h4><div class="v" id="fps">-</div></div>
        <div class="stat"><h4>码率</h4><div class="v" id="br">-</div></div>
        <div class="stat"><h4>延迟(约)</h4><div class="v" id="latency">-</div></div>
      </div>
      <div class="foot">
        · 说明：Chrome/Edge/Firefox 通过 <code>hls.js</code> 播放；Safari/iOS 原生支持 HLS。若跨域或 Referer 受限，请在服务端允许 CORS/正确防盗链。<br/>
        · 开源库：<a href="https://github.com/video-dev/hls.js" target="_blank" rel="noreferrer">hls.js</a>
      </div>
    </div>
  </div>

  <!-- hls.js from jsDelivr -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const urlInput = document.getElementById('url');
    const loadBtn = document.getElementById('load');
    const playBtn = document.getElementById('play');
    const video = document.getElementById('player');
    const statusEl = document.getElementById('status');
    const levelEl = document.getElementById('level');
    const bufferEl = document.getElementById('buffer');
    const resEl = document.getElementById('res');
    const fpsEl = document.getElementById('fps');
    const brEl = document.getElementById('br');
    const latEl = document.getElementById('latency');
    const autoplay = document.getElementById('autoplay');
    const muted = document.getElementById('muted');

    // 记住上次地址
    urlInput.value = localStorage.getItem('m3u8_url') || '';

    muted.addEventListener('change', () => video.muted = muted.checked);
    video.muted = muted.checked;

    function setStatus(text) { statusEl.textContent = text; }

    let hls; let lastPTS = null; let liveSync = 0;

    async function attach(url) {
      if (!url) { alert('请输入 m3u8 地址'); return; }
      localStorage.setItem('m3u8_url', url);
      setStatus('加载中…');

      // 先清理旧实例
      if (hls) { hls.destroy(); hls = null; }
      video.removeAttribute('src');
      video.load();

      // Safari / iOS 原生
      if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        bindVideoEvents();
        if (autoplay.checked) video.play().catch(()=>{});
        setStatus('原生播放');
        return;
      }

      if (window.Hls && window.Hls.isSupported()) {
        hls = new Hls({
          // 对直播更友好的一些设置
          liveDurationInfinity: true,
          maxLiveSyncPlaybackRate: 1.5,
          enableWorker: true,
          backBufferLength: 90,
        });
        hls.on(Hls.Events.MEDIA_ATTACHED, () => setStatus('媒体已连接'));
        hls.on(Hls.Events.MANIFEST_PARSED, (_, data) => {
          setStatus(`清单就绪：${data.levels.length} 个清晰度`);
          updateLevelInfo();
          if (autoplay.checked) video.play().catch(()=>{});
        });
        hls.on(Hls.Events.LEVEL_SWITCHED, updateLevelInfo);
        hls.on(Hls.Events.ERROR, (_, data) => {
          console.warn('HLS error', data);
          const { type, details, fatal } = data;
          if (fatal) {
            switch (type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                setStatus('网络错误，重试…');
                hls.startLoad();
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                setStatus('媒体错误，尝试恢复…');
                hls.recoverMediaError();
                break;
              default:
                setStatus('致命错误，重新加载…');
                hls.destroy();
                attach(url);
                break;
            }
          } else {
            // 非致命错误可忽略或记录
          }
        });
        hls.attachMedia(video);
        hls.loadSource(url);
        bindVideoEvents();
      } else {
        setStatus('当前浏览器不支持 HLS');
        alert('该浏览器不支持 HLS.js，请更换 Chrome/Edge/Firefox/Safari。');
      }
    }

    function updateLevelInfo() {
      if (hls && hls.levels && hls.currentLevel !== undefined) {
        const i = hls.currentLevel;
        const L = hls.levels[i] || {};
        levelEl.textContent = i >= 0 ? `#${i}` : '-';
        resEl.textContent = L.width ? `${L.width}×${L.height}` : '-';
        fpsEl.textContent = L.frameRate ? `${Math.round(L.frameRate)} fps` : '-';
        brEl.textContent = L.bitrate ? `${Math.round(L.bitrate/1000)} kbps` : '-';
      } else {
        levelEl.textContent = '-';
        resEl.textContent = '-';
        fpsEl.textContent = '-';
        brEl.textContent = '-';
      }
    }

    function bindVideoEvents() {
      video.addEventListener('loadedmetadata', () => setStatus('元数据已加载'));
      video.addEventListener('playing', () => setStatus('播放中'));
      video.addEventListener('pause', () => setStatus('已暂停'));
      video.addEventListener('error', () => setStatus('播放错误'));
    }

    // 简易统计：缓冲、延迟估算
    setInterval(() => {
      try {
        const buf = video.buffered;
        const ct = video.currentTime;
        let end = ct;
        for (let i=0;i<buf.length;i++) end = Math.max(end, buf.end(i));
        const buffered = Math.max(0, end - ct);
        bufferEl.textContent = buffered.toFixed(1);

        // 直播延迟估算：基于 PTS 推断（仅近似）
        if (hls && hls.levelDetails && hls.levelDetails.live) {
          // hls.latency + liveSyncPosition may be available in some builds
          if (hls.latency) {
            liveSync = hls.latency;
          } else if (hls.levelDetails && hls.levelDetails.edge) {
            liveSync = Math.max(0, hls.levelDetails.edge - video.currentTime);
          }
          latEl.textContent = (liveSync || 0).toFixed(1) + 's';
        } else {
          latEl.textContent = '-';
        }
      } catch (_) {}
    }, 500);

    loadBtn.addEventListener('click', () => attach(urlInput.value.trim()));
    playBtn.addEventListener('click', () => {
      if (video.paused) video.play().catch(()=>{}); else video.pause();
    });

    // 回车直接加载
    urlInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') attach(urlInput.value.trim());
    });

    // 如果地址栏已有 ?src=xxx 自动加载
    const params = new URLSearchParams(location.search);
    const preset = params.get('src');
    if (preset) {
      urlInput.value = preset;
      attach(preset);
    }
  </script>
</body>
</html>
